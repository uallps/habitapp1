# =====================================================
# GitHub Action: Gamification Module (Lucas)
# =====================================================
# Este workflow es especÃ­fico para el mÃ³dulo de GamificaciÃ³n
# Se ejecuta cuando hay cambios en los archivos del mÃ³dulo
# Sistema de puntos, niveles, logros, trofeos y recompensas
# =====================================================

name: ðŸŽ® Gamification Module CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'HabitApp/Modules/Gamification/**'
      - 'HabitApp/Premium/Gamification/**'
      - 'HabitAppTests/GamificationTests.swift'
      - '.github/workflows/module-gamification.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'HabitApp/Modules/Gamification/**'
      - 'HabitApp/Premium/Gamification/**'
      - 'HabitAppTests/GamificationTests.swift'
      - '.github/workflows/module-gamification.yml'

env:
  SCHEME: "HabitApp"
  DESTINATION: "platform=iOS Simulator,name=iPhone 17"
  MODULE_NAME: "Gamification"
  MODULE_AUTHOR: "Lucas"

jobs:
  # ============================================
  # JOB 1: Lint & Static Analysis
  # ============================================
  lint:
    name: ðŸ” Lint Gamification Module
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ“‹ Module Info
      run: |
        echo "========================================="
        echo "ðŸŽ® Gamification Module CI/CD"
        echo "Author: ${{ env.MODULE_AUTHOR }}"
        echo "Features: XP, Levels, Achievements, Trophies, Daily Rewards"
        echo "========================================="
    
    - name: ðŸ”§ Install SwiftLint
      run: brew install swiftlint || true
    
    - name: ðŸ” Run SwiftLint on Gamification Module
      run: |
        echo "Linting Gamification Module Implementation..."
        swiftlint lint --path HabitApp/Modules/Gamification --reporter github-actions-logging || true
        
        echo "Linting Gamification Premium Features..."
        swiftlint lint --path HabitApp/Premium/Gamification --reporter github-actions-logging || true

  # ============================================
  # JOB 2: Build Module
  # ============================================
  build:
    name: ðŸ”¨ Build with Gamification Module
    runs-on: macos-latest
    needs: lint
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ”§ (Skip) Use runner default Xcode
      run: echo "Using default Xcode on runner"
    
    - name: ðŸ“‹ Show Xcode version
      run: xcodebuild -version
    
    - name: ðŸ“ Create logs directory
      run: mkdir -p build/logs
    
    - name: ðŸŽ® List Gamification Files
      run: |
        echo "ðŸ“‚ Gamification Module Files:"
        echo "--- Module Implementation ---"
        find HabitApp/Modules/Gamification -name "*.swift" 2>/dev/null || echo "No module files found"
        echo ""
        echo "--- Premium Gamification Features ---"
        find HabitApp/Premium/Gamification -name "*.swift" 2>/dev/null || echo "No premium files found"
    
    - name: ðŸ”¨ Build for testing
      run: |
        echo "Checking available simulators..."
        if xcrun simctl list devices available | grep -Fq 'iPhone 17 ('; then
          DEST="platform=iOS Simulator,name=iPhone 17"
        else
          DEST="platform=iOS Simulator"
        fi
        echo "Using destination: $DEST"
        xcodebuild build-for-testing \
          -project HabitApp.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DEST" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          2>&1 | tee build/logs/build.log | xcpretty --color && exit ${PIPESTATUS[0]}
    
    - name: ðŸ“¤ Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: gamification-module-build-logs
        path: |
          build/logs/
          ~/Library/Developer/Xcode/DerivedData/**/Logs/
        retention-days: 14

  # ============================================
  # JOB 3: Module Tests
  # ============================================
  test:
    name: ðŸ§ª Test Gamification Module
    runs-on: macos-latest
    needs: build
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ”§ (Skip) Use runner default Xcode
      run: echo "Using default Xcode on runner"
    
    - name: ðŸ“ Create logs directory
      run: mkdir -p build/logs
    
    - name: ðŸ§ª Run Gamification Module Tests
      run: |
        echo "Running Gamification Module Tests..."
        echo "Testing: XP System, Levels, Achievements, Trophies, Daily Rewards"
        
        echo "Checking available simulators for test step..."
        SIMS=$(xcrun simctl list devices available || true)
        if echo "$SIMS" | grep -Fq 'iPhone 17 ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17"
        elif echo "$SIMS" | grep -Fq 'iPhone 17 Pro ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17 Pro"
        elif echo "$SIMS" | grep -Fq 'iPhone 17 Pro Max ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17 Pro Max"
        else
          DEST_LOCAL="platform=iOS Simulator"
        fi
        echo "DEST=$DEST_LOCAL" >> $GITHUB_ENV
        echo "Using destination for tests: $DEST_LOCAL"

        xcodebuild test \
          -project HabitApp.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DEST_LOCAL" \
          -configuration Debug \
          -only-testing:HabitAppTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -resultBundlePath build/logs/TestResults.xcresult \
          2>&1 | tee build/logs/test.log | xcpretty --color || true
    
    - name: ðŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gamification-module-test-results
        path: |
          build/logs/
          build/reports/
        retention-days: 14

  # ============================================
  # JOB 4: UI Preview Check
  # ============================================
  ui-check:
    name: ðŸŽ¨ UI Preview Check
    runs-on: macos-latest
    needs: build
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸŽ¨ Check SwiftUI Previews
      run: |
        echo "Checking Gamification SwiftUI previews..."
        echo ""
        echo "ðŸ“ GamificationHubView:"
        grep -l "PreviewProvider\|#Preview" HabitApp/Premium/Gamification/Views/GamificationHubView.swift && echo "âœ… Preview found" || echo "âš ï¸ No preview found"
        
        echo ""
        echo "ðŸ“ AchievementsTabView:"
        grep -l "PreviewProvider\|#Preview" HabitApp/Premium/Gamification/Views/AchievementsTabView.swift && echo "âœ… Preview found" || echo "âš ï¸ No preview found"
        
        echo ""
        echo "ðŸ“ TrophyRoomView:"
        grep -l "PreviewProvider\|#Preview" HabitApp/Premium/Gamification/Views/TrophyRoomView.swift && echo "âœ… Preview found" || echo "âš ï¸ No preview found"
        
        echo ""
        echo "ðŸ“ DailyRewardsView:"
        grep -l "PreviewProvider\|#Preview" HabitApp/Premium/Gamification/Views/DailyRewardsView.swift && echo "âœ… Preview found" || echo "âš ï¸ No preview found"

  # ============================================
  # JOB 5: Feature Verification
  # ============================================
  verify-features:
    name: âœ… Verify Gamification Features
    runs-on: macos-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸŽ® Verify XP System
      run: |
        echo "Checking XP System implementation..."
        grep -q "totalXP" HabitApp/Premium/Gamification/Models/GamificationModels.swift && echo "âœ… XP system found" || echo "âŒ XP system missing"
    
    - name: ðŸ† Verify Level System
      run: |
        echo "Checking Level System implementation..."
        grep -q "UserLevel" HabitApp/Premium/Gamification/Models/GamificationModels.swift && echo "âœ… Level system found" || echo "âŒ Level system missing"
        grep -q "levels" HabitApp/Premium/Gamification/Models/GamificationModels.swift && echo "âœ… Level array found" || echo "âŒ Level array missing"
    
    - name: ðŸ… Verify Achievement System
      run: |
        echo "Checking Achievement System implementation..."
        grep -q "Achievement" HabitApp/Premium/Gamification/Models/GamificationModels.swift && echo "âœ… Achievement model found" || echo "âŒ Achievement model missing"
        grep -q "AchievementRarity" HabitApp/Premium/Gamification/Models/GamificationModels.swift && echo "âœ… Rarity system found" || echo "âŒ Rarity system missing"
    
    - name: ðŸ† Verify Trophy System
      run: |
        echo "Checking Trophy System implementation..."
        grep -q "Trophy" HabitApp/Premium/Gamification/Models/GamificationModels.swift && echo "âœ… Trophy model found" || echo "âŒ Trophy model missing"
        grep -q "TrophyTier" HabitApp/Premium/Gamification/Models/GamificationModels.swift && echo "âœ… Trophy tiers found" || echo "âŒ Trophy tiers missing"
    
    - name: ðŸŽ Verify Daily Rewards
      run: |
        echo "Checking Daily Rewards implementation..."
        grep -q "DailyReward" HabitApp/Premium/Gamification/Models/GamificationModels.swift && echo "âœ… Daily rewards found" || echo "âŒ Daily rewards missing"
    
    - name: ðŸ“Š Feature Summary
      run: |
        echo ""
        echo "========================================="
        echo "ðŸŽ® Gamification Module Feature Summary"
        echo "========================================="
        echo "ðŸ“ Models:"
        ls -la HabitApp/Premium/Gamification/Models/ 2>/dev/null || echo "No models found"
        echo ""
        echo "ðŸ“ Store:"
        ls -la HabitApp/Premium/Gamification/Store/ 2>/dev/null || echo "No store found"
        echo ""
        echo "ðŸ“ Views:"
        ls -la HabitApp/Premium/Gamification/Views/ 2>/dev/null || echo "No views found"
        echo ""
        echo "ðŸ“ Module Implementation:"
        ls -la HabitApp/Modules/Gamification/ 2>/dev/null || echo "No module impl found"

  # ============================================
  # JOB 6: Module Documentation
  # ============================================
  docs:
    name: ðŸ“š Generate Gamification Docs
    runs-on: macos-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ“š Check Module Documentation
      run: |
        echo "Checking documentation for Gamification Module..."
        if [ -f "docs/modules/MODULO_GAMIFICACION.md" ]; then
          echo "âœ… Documentation found"
          cat docs/modules/MODULO_GAMIFICACION.md
        else
          echo "âš ï¸ Documentation not found at docs/modules/MODULO_GAMIFICACION.md"
          echo "Creating placeholder..."
        fi
    
    - name: ðŸ“Š Generate Feature Stats
      run: |
        echo ""
        echo "========================================="
        echo "ðŸ“Š Gamification Module Statistics"
        echo "========================================="
        echo ""
        echo "Swift Files:"
        find HabitApp/Premium/Gamification HabitApp/Modules/Gamification -name "*.swift" 2>/dev/null | wc -l | xargs echo "  Total:"
        echo ""
        echo "Lines of Code:"
        find HabitApp/Premium/Gamification HabitApp/Modules/Gamification -name "*.swift" -exec cat {} \; 2>/dev/null | wc -l | xargs echo "  Total:"
        echo ""
        echo "Test Files:"
        grep -l "Gamification" HabitAppTests/*.swift 2>/dev/null | wc -l | xargs echo "  Total:"
