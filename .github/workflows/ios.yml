name: iOS CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  SCHEME: "HabitApp"
  DESTINATION: "platform=iOS Simulator,name=iPhone 17"

jobs:
  # ============================================
  # JOB 1: Build
  # ============================================
  build:
    name: 游댣 Build
    runs-on: macos-latest
    
    steps:
    - name: 游닌 Checkout repository
      uses: actions/checkout@v4
    
    - name: 游댢 (Skip) Use runner default Xcode
      run: echo "Using default Xcode on runner"
    
    - name: 游늶 Show Xcode version
      run: xcodebuild -version
    
    - name: 游님 List available simulators
      run: xcrun simctl list devices available

    - name: 游띯 Determine simulator destination
      run: |
        echo "Checking available simulators..."
        if xcrun simctl list devices available | grep -Fq 'iPhone 17 ('; then
          echo "DEST=platform=iOS Simulator,name=iPhone 17" >> $GITHUB_ENV
        else
          echo "DEST=platform=iOS Simulator" >> $GITHUB_ENV
        fi
        echo "Using destination: $DEST"
    
    - name: 游댣 Build for testing
      run: |
        xcodebuild build-for-testing \
          -project HabitApp.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DEST" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty --color && exit ${PIPESTATUS[0]}

  # ============================================
  # JOB 2: Unit Tests
  # ============================================
  test:
    name: 游빍 Unit Tests
    runs-on: macos-latest
    needs: build
    
    steps:
    - name: 游닌 Checkout repository
      uses: actions/checkout@v4
    
    - name: 游댢 (Skip) Use runner default Xcode
      run: echo "Using default Xcode on runner"
    
    - name: 游빍 Run Unit Tests
      run: |
        echo "Checking available simulators for test step..."
        SIMS=$(xcrun simctl list devices available || true)
        if echo "$SIMS" | grep -Fq 'iPhone 17 ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17"
        elif echo "$SIMS" | grep -Fq 'iPhone 17 Pro ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17 Pro"
        elif echo "$SIMS" | grep -Fq 'iPhone 17 Pro Max ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17 Pro Max"
        else
          DEST_LOCAL="platform=iOS Simulator"
        fi
        echo "DEST=$DEST_LOCAL" >> $GITHUB_ENV
        echo "Using destination for tests: $DEST_LOCAL"
        xcodebuild test \
          -project HabitApp.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DEST_LOCAL" \
          -configuration Debug \
          -only-testing:HabitAppTests \
          -resultBundlePath TestResults.xcresult \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty --color --report junit && exit ${PIPESTATUS[0]}
    
    - name: 游늵 Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          TestResults.xcresult
          build/reports/
        retention-days: 30

  # ============================================
  # JOB 3: Build Release Archive
  # ============================================
  archive:
    name: 游닍 Build Release
    runs-on: macos-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 游닌 Checkout repository
      uses: actions/checkout@v4
    
    - name: 游댢 (Skip) Use runner default Xcode
      run: echo "Using default Xcode on runner"
    
    - name: 游닍 Build Release Archive
      run: |
        xcodebuild archive \
          -project HabitApp.xcodeproj \
          -scheme "$SCHEME" \
          -destination "generic/platform=iOS Simulator" \
          -configuration Release \
          -archivePath build/HabitApp.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES
    
    - name: 游늵 Generate build info
      run: |
        mkdir -p build/artifacts
        echo "Build Information" > build/artifacts/BUILD_INFO.txt
        echo "=================" >> build/artifacts/BUILD_INFO.txt
        echo "Date: $(date)" >> build/artifacts/BUILD_INFO.txt
        echo "Commit: ${{ github.sha }}" >> build/artifacts/BUILD_INFO.txt
        echo "Branch: ${{ github.ref_name }}" >> build/artifacts/BUILD_INFO.txt
        echo "Runner: ${{ runner.os }}" >> build/artifacts/BUILD_INFO.txt
        xcodebuild -version >> build/artifacts/BUILD_INFO.txt
    
    - name: 游닋 Upload Release Archive
      uses: actions/upload-artifact@v4
      with:
        name: HabitApp-Release-${{ github.sha }}
        path: |
          build/HabitApp.xcarchive
          build/artifacts/
        retention-days: 90

  # ============================================
  # JOB 4: Code Quality
  # ============================================
  lint:
    name: 游댌 Code Quality
    runs-on: macos-latest
    
    steps:
    - name: 游닌 Checkout repository
      uses: actions/checkout@v4
    
    - name: 游늵 Count lines of code
      run: |
        echo "游늵 Project Statistics"
        echo "====================="
        echo ""
        echo "Swift files:"
        find . -name "*.swift" -not -path "./.build/*" | wc -l
        echo ""
        echo "Total lines of Swift code:"
        find . -name "*.swift" -not -path "./.build/*" -exec cat {} \; | wc -l
        echo ""
        echo "Files by directory:"
        find . -name "*.swift" -not -path "./.build/*" | xargs dirname | sort | uniq -c | sort -rn
    
    - name: 游늶 Generate file list
      run: |
        mkdir -p reports
        echo "# HabitApp Source Files" > reports/FILE_LIST.md
        echo "" >> reports/FILE_LIST.md
        echo "Generated: $(date)" >> reports/FILE_LIST.md
        echo "" >> reports/FILE_LIST.md
        echo "## Swift Files" >> reports/FILE_LIST.md
        find . -name "*.swift" -not -path "./.build/*" | sort >> reports/FILE_LIST.md
    
    - name: 游닋 Upload reports
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-reports
        path: reports/
        retention-days: 30
