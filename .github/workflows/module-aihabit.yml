# =====================================================
# GitHub Action: AI Habit Module (Diego)
# =====================================================
# Este workflow es especÃ­fico para el mÃ³dulo de IA
# Se ejecuta cuando hay cambios en los archivos del mÃ³dulo
# =====================================================

name: ğŸ¤– AI Habit Module CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'HabitApp/Modules/AIHabit/**'
      - 'HabitApp/Premium/Views/CameraHabitView.swift'
      - 'HabitApp/Premium/Views/HabitSuggestionSheet.swift'
      - 'HabitApp/Premium/Services/OpenAIService.swift'
      - '.github/workflows/module-aihabit.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'HabitApp/Modules/AIHabit/**'
      - 'HabitApp/Premium/Views/CameraHabitView.swift'
      - 'HabitApp/Premium/Views/HabitSuggestionSheet.swift'
      - 'HabitApp/Premium/Services/OpenAIService.swift'
      - '.github/workflows/module-aihabit.yml'

env:
  SCHEME: "HabitApp"
  DESTINATION: "platform=iOS Simulator,name=iPhone 17"
  MODULE_NAME: "AIHabit"
  MODULE_AUTHOR: "Diego"

jobs:
  # ============================================
  # JOB 1: Lint & Static Analysis
  # ============================================
  lint:
    name: ğŸ” Lint AI Habit Module
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ“‹ Module Info
      run: |
        echo "========================================="
        echo "ğŸ¤– AI Habit Module CI/CD"
        echo "Author: ${{ env.MODULE_AUTHOR }}"
        echo "========================================="
    
    - name: ğŸ”§ Install SwiftLint
      run: brew install swiftlint || true
    
    - name: ğŸ” Run SwiftLint on AI Habit Module
      run: |
        swiftlint lint --path HabitApp/Modules/AIHabit --reporter github-actions-logging || true
        swiftlint lint --path HabitApp/Premium/Views/CameraHabitView.swift --reporter github-actions-logging || true
        swiftlint lint --path HabitApp/Premium/Services/OpenAIService.swift --reporter github-actions-logging || true

  # ============================================
  # JOB 2: Security Check
  # ============================================
  security:
    name: ğŸ” Security Check
    runs-on: macos-latest
    needs: lint
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ” Check for API Key Leaks
      run: |
        echo "Checking for API key leaks in AI Habit Module..."
        # Verificar que no haya API keys hardcodeadas
        if grep -r "sk-" HabitApp/Modules/AIHabit/ HabitApp/Premium/Services/OpenAIService.swift 2>/dev/null | grep -v "Secrets.plist"; then
          echo "âš ï¸ Possible API key leak detected!"
          exit 1
        else
          echo "âœ… No API key leaks detected"
        fi
    
    - name: ğŸ” Verify Secrets Configuration
      run: |
        echo "Checking Secrets.plist configuration..."
        if [ -f "HabitApp/Config/Secrets.plist" ]; then
          echo "âš ï¸ WARNING: Secrets.plist exists - ensure it's in .gitignore"
        fi
        if [ -f "HabitApp/Config/Secrets.plist.example" ]; then
          echo "âœ… Secrets.plist.example found"
        fi

  # ============================================
  # JOB 3: Build Module
  # ============================================
  build:
    name: ğŸ”¨ Build with AI Habit Module
    runs-on: macos-latest
    needs: security
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ”§ (Skip) Use runner default Xcode
      run: echo "Using default Xcode on runner"
    
    - name: ğŸ“‹ Show Xcode version
      run: xcodebuild -version
    
    - name: ï¿½ Create logs directory
      run: mkdir -p build/logs
    
    - name: ğŸ”¨ Build for testing
      run: |
        echo "Checking available simulators..."
        if xcrun simctl list devices available | grep -Fq 'iPhone 17 ('; then
          DEST="platform=iOS Simulator,name=iPhone 17"
        else
          DEST="platform=iOS Simulator"
        fi
        echo "Using destination: $DEST"
        xcodebuild build-for-testing \
          -project HabitApp.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DEST" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          2>&1 | tee build/logs/build.log | xcpretty --color && exit ${PIPESTATUS[0]}
    
    - name: ğŸ“¤ Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: aihabit-module-build-logs
        path: |
          build/logs/
          ~/Library/Developer/Xcode/DerivedData/**/Logs/
        retention-days: 14

  # ============================================
  # JOB 4: Module Tests
  # ============================================
  test:
    name: ğŸ§ª Test AI Habit Module
    runs-on: macos-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ”§ (Skip) Use runner default Xcode
      run: echo "Using default Xcode on runner"
    
    - name: ğŸ“ Create logs directory
      run: mkdir -p build/logs
    
    - name: ğŸ§ª Run AI Habit Module Tests
      run: |
        echo "Checking available simulators for test step..."
        SIMS=$(xcrun simctl list devices available || true)
        if echo "$SIMS" | grep -Fq 'iPhone 17 ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17"
        elif echo "$SIMS" | grep -Fq 'iPhone 17 Pro ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17 Pro"
        elif echo "$SIMS" | grep -Fq 'iPhone 17 Pro Max ('; then
          DEST_LOCAL="platform=iOS Simulator,name=iPhone 17 Pro Max"
        else
          DEST_LOCAL="platform=iOS Simulator"
        fi
        echo "DEST=$DEST_LOCAL" >> $GITHUB_ENV
        echo "Using destination for tests: $DEST_LOCAL"
        xcodebuild test \
          -project HabitApp.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DEST_LOCAL" \
          -configuration Debug \
          -only-testing:HabitAppTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -resultBundlePath build/logs/TestResults.xcresult \
          2>&1 | tee build/logs/test.log | xcpretty --color && exit ${PIPESTATUS[0]}
    
    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: aihabit-module-test-results
        path: |
          build/logs/
          build/reports/
        retention-days: 14

  # ============================================
  # JOB 5: Module Documentation
  # ============================================
  docs:
    name: ğŸ“š Generate AI Habit Docs
    runs-on: macos-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ“š Check Module Documentation
      run: |
        echo "Checking documentation for AI Habit Module..."
        if [ -f "docs/modules/MODULO_AIHABIT.md" ]; then
          echo "âœ… Documentation found"
        else
          echo "âš ï¸ Documentation not found at docs/modules/MODULO_AIHABIT.md"
        fi
